#!/data/data/com.termux/files/usr/bin/bash

#==================================================#
# 备用信息
#
#    \[\[(.*\n)+\]\]
#
#    dofile '/data/data/com.termux/files/home/.bmkey.lua'
#
#    bash /sdcard/0DontStarve/bmsh/bmhei.txt
#
#    pkg i lua wget p7zip apksigner -y
#
#    main.50.com.kleientertainment.doNotStarveShipwrecked.obb
#
#==================================================#
#    主程序                   main
#    格式化输出               bmsay str code
#    获取文件大小             get_file_size file
#    获取GITHUB文件          get_file_github id rename
#    检查BMSH200601.KEY     bmsh_sw_key_exist
#    检查BMSH200601.JKS     bmsh_sw_jks_exist
#    检查BMSH200601.APP     bmsh_sw_apk_exist
#    检查BMSH200601.OBB    bmsh_sw_obb_exist
#    检查BMSH200601.OPH     bmsh_sw_zip_exist
#    生成整合包               add_to_apk ...
#    生成数据包               add_to_obb ...
#    移除模组                 rm_to_obb ...
#==================================================#


BMVER=1.6
#上次使用时间
FILE_LASTTIME="/data/data/com.termux/files/home/.bmhei_lasttime"
DATA_LASTTIME=$(cat "$FILE_LASTTIME") >/dev/null 2>&1
DATA_LASTTIME=${DATA_LASTTIME:-"2009-09-09 09:09:09"}
#记录当前时间
echo $(date '+%Y-%m-%d %H:%M:%S') >"$FILE_LASTTIME"



function main() {
	#主程序
	if test $? -ne 0 ; then
		exit 99
	fi

	mkdir -p /sdcard/bmsh >/dev/null 2>&1

	cd /sdcard/bmsh >/dev/null 2>&1

	WHERE_ARE_YOU="CHINA"

	#add_to_apk 200601 999999 1 2 22

	#add_to_obb 2 5

	#rm_to_obb 2

	clear

	while true; do
		clear
		bmsay "1.我是小黑，需要我帮忙么？\n" 33m 0
		bmsay "  1.我是新手...\n" 33m 0
		bmsay " *2.嗯，请你帮帮我...\n" 33m 0
		bmsay "  3.对不起，我不想继续了。\n" 33m 0
		bmsay "  提示：输入选项并“回车”。\n" 33m 0
		bmsay "你的输入：" 33m 0
		read input 
		echo
		case $input in
		[1])
			bmsay "小黑  [""$BMVER""]  樂不思蜀\n" 33m 0
			bmsay "  1.输入正确选项，我会帮你进行相应操作。\n" 34m 0
			bmsay "  2.什么都不输入，我会帮你进行“ * ”操作。\n" 34m 0
			bmsay "  3.输入错误选项，我会帮你进行“ * ”操作。\n" 34m 0
			bmsay "你记住了吗？\n" 33m 0
			pause
			break
			;;
		[3] )
			clear
			bmsay "小黑希望下次能帮到你！\n" 33m 0
			exit 99
			;;
		*)
			break
			;;
		esac
	done
	echo

	while true; do
	clear
		bmsay "2.你想要“获取”小黑专用版？\n" 33m 0
		bmsay "  1.是的，我还没安装游戏。\n" 33m 0
		bmsay " *2.不用，我想进行下一步。\n" 33m 0
		bmsay "  3.对不起，我不想继续了。\n" 33m 0
		bmsay "你的输入：" 33m 0
		read input 
		echo
		case $input in
		[1])
			add_to_apk
			break
			;;
		[3])
			clear
			bmsay "小黑希望下次能帮到你！\n" 33m 0
			exit 99
			;;
		*)
			break
			;;
		esac
	done
	echo

	while true; do
	clear
		bmsay "3.你想要“安装”一些文件么？\n" 33m 0
		bmsay "  1.是的，快帮我安装一下。\n" 33m 0
		bmsay " *2.不用，我想进行下一步。\n" 33m 0
		bmsay "  3.对不起，我不想继续了。\n" 33m 0
		bmsay "你的输入：" 33m 0
		read input 
		echo
		case $input in
		[1])
			bmsay "请回复它们的编号，例如：1 22 333 ...\n" 33m 0
			bmsay "你的输入：" 33m 0
			read input 
			echo
			add_to_obb "$input"
			break
			;;
		[3])
			clear
			bmsay "小黑希望下次能帮到你！\n" 33m 0
			exit 99
			;;
		*)
			break
			;;
		esac
	done
	echo

	while true; do
	clear
		bmsay "4.你想要“移除”一些文件么？\n" 33m 0
		bmsay "  1.是的，快帮我移除它们。\n" 33m 0
		bmsay " *2.不用，我想进行下一步。\n" 33m 0
		bmsay "  3.对不起，我不想继续了。\n" 33m 0
		bmsay "你的输入：" 33m 0
		read input 
		echo
		case $input in
		[1])
			bmsay "请回复它们的编号，例如：1 22 333 ...\n" 33m 0
			bmsay "你的输入：" 33m 0
			read input 
			rm_to_obb "$input"
			break
			;;
		[3])
			clear
			bmsay "小黑希望下次能帮到你！\n" 33m 0
			exit 99
			;;
		*)
			break
			;;
		esac
	done
	echo

	while true; do
	clear
		bmsay "5.你想要“分享”给朋友么？\n" 33m 0
		bmsay "  1.是的，我朋友也想要玩。\n" 33m 0
		bmsay " *2.不用，我想进行下一步。\n" 33m 0
		bmsay "  3.对不起，我不想继续了。\n" 33m 0
		bmsay "你的输入：" 33m 0
		read input 
		echo
		case $input in
		[1])
			add_to_apk 0
			break
			;;
		[3])
			clear
			bmsay "小黑希望下次能帮到你！\n" 33m 0
			exit 99
			;;
		*)
			break
			;;
		esac
	done
	echo

	main

}

function bmsay() {
	if test "$2"; then
		code=$2
		bmsh="BMSH: "
	else
		code=37m
		bmsh=""
	fi
	if test "$3" = "0"; then
		bmsh=""
	fi
	printf "\033[""$code""$bmsh""$1""\033[0m"
}

function pause() {
	bmsay "按回车继续...\n" 34m 0
	read -s -n 1 press
}


function get_file_size() {
#获取文件大小
	if test "$1"; then
		if test -f "$1"; then
			printf $(ls -l "$1" | awk '{print $5}')
			return 0
		fi
	fi
	printf "0"
	return 1
}

function get_file_github() {
	#获取GITHUB文件
	#https://shrill-pond-3e81.hunsh.workers.dev/?q=
	#https://gh.api.99988866.xyz/
	#https://github.com/cnzixn/bmsh-patch/archive/GIT200601.zip
	if test "$1"; then
		FID=$(printf "%04d" "$1")
		BNAME=GIT"$FID"
		GNAME=$(echo $FID | awk '{printf("bmsh-mods%1d",($1-1)/50%10+1)}')
		if test "$FID" -gt 9999; then
			GNAME="bmsh-patch"
		fi
		URL=https://github.com/cnzixn/"$GNAME"/archive/"$BNAME".zip
		CN_URL=https://shrill-pond-3e81.hunsh.workers.dev/?q="$URL"
		url="$URL"
		if test "$WHERE_ARE_YOU" == "CHINA"; then
			url="$CN_URL"
		fi
		file="$BNAME".ZIP
		if test "$2"; then
			file="$2"
		fi
		wget -O "$file" "$url"
		return $?
	fi
}


function init() {
	#计算上次执行时间差
currenttime="$(date +%s -d "$(date '+%Y-%m-%d %H:%M:%S')")"
lasttime=$(date +%s -d "$DATA_LASTTIME")
difftime=$(expr $currenttime - $lasttime)
	
	if test "$difftime" -gt 18000; then
		echo "获取最新文件bmhei.txt"
		cd /data/data/com.termux/files/home
		wget -O ".bmhei.txt" "https://cnzixn.github.io/files/bmsh/bmhei.txt"
		if test "$?" -ne "0"; then
			printf "获取最新文件bmhei.txt失败."
			exit 99
		else
			cp -rf ".bmhei.txt" $PREFIX/bin/hei
		fi
	fi

}



#检查BMSH200601.KEY
function bmsh_sw_key_exist() {
	bmsh_sw_key=BMSH200601.KEY
	size=$(get_file_size "$bmsh_sw_key")
	if test "$size" -eq "1397"; then
		#BMSH200601.KEY已存在
		bmsay "获取BMSH200601.KEY成功.\n" 32m
		cp $bmsh_sw_key /sdcard/MT2/keys/
		return 0
	else
		bmsay "获取BMSH200601.KEY...\n" 33m
		wget -O "BMSH200601.KEY" "https://cnzixn.github.io/files/bmsh/bmsh_sw.key"
		if test "$?" -eq "0"; then
			bmsay "获取BMSH200601.KEY成功.\n" 32m
			cp $bmsh_sw_key /sdcard/MT2/keys/
			return 0
		else
			bmsay "获取BMSH200601.KEY失败.\n" 31m
			pause
			main
		fi
	fi
	return 1
}

#检查BMSH200601.JKS
function bmsh_sw_jks_exist() {
	bmsh_sw_jks=BMSH200601.JKS
	size=$(get_file_size "$bmsh_sw_jks")
	if test "$size" -eq "1286"; then
		#BMSH200601.JKS已存在
		bmsay "获取BMSH200601.JKS成功.\n" 32m
		cp $bmsh_sw_jks /sdcard/MT2/jks/
		return 0
	else
		bmsay "获取BMSH200601.JKS...\n" 33m
		wget -O "BMSH200601.JKS" "https://cnzixn.github.io/files/bmsh/bmsh_sw.jks"
		if test "$?" -eq "0"; then
			bmsay "获取BMSH200601.JKS成功.\n" 32m
			cp $bmsh_sw_jks /sdcard/MT2/jks/
			return 0
		else
			bmsay "获取BMSH200601.JKS失败.\n" 31m
			pause
			main
		fi
	fi
	return 1
}

#检查BMSH200601.APP
function bmsh_sw_apk_exist() {
	bmsh_sw_apk=BMSH200601.APP
	size=$(get_file_size "$bmsh_sw_apk")
	if test "$size" -eq "6880098"; then
		#BMSH200601.APP已存在
		bmsay "获取BMSH200601.APP成功.\n" 32m
		return 0
	else
		bmsay "获取BMSH200601.APP...\n" 33m
		#https://t.cn/A6LjRekn
		wget -O "BMSH200601.APP" "https://sj.71acg.com/hykb/201911/20191126jhht1.27.apk"
		if test "$?" -eq "0"; then
			bmsay "获取BMSH200601.APP成功.\n" 32m
			return 0
		else
			bmsay "获取BMSH200601.APP失败.\n" 31m
			pause
			main
		fi
	fi
	return 1
}

#检查BMSH200601.OBB
function bmsh_sw_obb_exist() {
	bmsh_sw_obb=BMSH200601.OBB
	size=$(get_file_size "$bmsh_sw_obb")
	if test "$size" -eq "521631690"; then
		#BMSH200601.OBB已存在
		bmsay "获取BMSH200601.OBB成功.\n" 32m
		return 0
	else
		SAVEIFS=$IFS
		IFS=$(echo -en "\n\b")
		for obb in $(find "/sdcard/" -name "main.50.com.kleientertainment.doNotStarveShipwrecked*.obb"); do
			bmsh_sw_obb="$obb"
			size=$(get_file_size "$bmsh_sw_obb")
			if test "$size" -eq "521631690"; then
				#BMSH200601.OBB已存在
				bmsay "获取BMSH200601.OBB成功.\n" 32m
				mv $bmsh_sw_obb BMSH200601.OBB
				return 0
			fi
		done
		IFS=$SAVEIFS

		bmsay "获取BMSH200601.OBB...\n" 33m
		#https://t.cn/A6LjRD2i
		wget -O "BMSH200601.OBB" "https://sj.71acg.com/hykb/shujubao/main.50.com.kleientertainment.doNotStarveShipwrecked.obb"
		if test "$?" -eq "0"; then
			bmsay "获取BMSH200601.OBB成功.\n" 32m
			return 0
		else
			bmsay "获取BMSH200601.OBB失败.\n" 31m
			pause
			main
		fi

	fi
	return 1
}

#检查BMSH200601.OPH
function bmsh_sw_zip_exist() {
	bmsh_sw_zip=BMSH200601.OPH
	size=$(get_file_size "$bmsh_sw_zip")
	if test "$size" -gt "6000000"; then
		#BMSH200601.OPH已存在
		bmsay "获取BMSH200601.OPH成功.\n" 32m
		return 0
	else
		bmsay "获取BMSH200601.OPH...\n" 33m
		#https://t.cn/A6LjRekn
		get_file_github 200601 BMSH200601.OPH
		if test "$?" -eq "0"; then
			bmsay "获取BMSH200601.OPH成功.\n" 32m
			return 0
		else
			bmsay "获取BMSH200601.OPH失败.\n" 31m
			pause
			main
		fi
	fi
	return 1
}

#修改数据包：移除文件
function rm_to_obb() {
	if test -z "$*"; then
		bmsay "我不知道你要移除哪些文件.\n" 31m
		pause
		return 1
	fi

	if test ! -f "/sdcard/Android/obb/bm.kleientertainment.doNotStarveShipwrecked/main.50.bm.kleientertainment.doNotStarveShipwrecked.obb"; then
		bmsay "你好像还没有“安装”文件.\n" 31m
		pause
		return 1
	fi

	if test "$1" -eq "-1"; then
		bmsay "移除“全部”已安装文件...\n" 33m
		rm /sdcard/Android/obb/bm.kleientertainment.doNotStarveShipwrecked/main.50.bm.kleientertainment.doNotStarveShipwrecked.obb
		if test "$?" -eq "0"; then
			bmsay "移除“全部”已安装文件成功.\n" 32m
		else
			bmsay "移除“全部”已安装文件失败.\n" 31m
		fi
		pause
		return $?
	fi

	ids=$(echo "$*" )
	for id in $ids ; do
		id=$(echo "$id" | tr -cd "[0-9]")
		if test -n "$id"; then
			fname=$(printf "BM%04d" "$id")
			bmsay "移除""$fname""...\n" 33m
			7z d -tzip "/sdcard/Android/obb/bm.kleientertainment.doNotStarveShipwrecked/main.50.bm.kleientertainment.doNotStarveShipwrecked.obb" "mods/$fname"
			if test "$?" -eq "0"; then
				bmsay "移除""$fname""成功.\n" 32m
			else
				bmsay "移除""$fname""失败.\n" 31m
			fi
		fi
	done
	pause
	return 1
	cd /sdcard/bmsh >/dev/null 2>&1
}

#修改数据包：添加文件
function add_to_obb() {
	cd /sdcard/bmsh >/dev/null 2>&1
	rm -rf add_to_obb >/dev/null 2>&1
	mkdir -p add_to_obb >/dev/null 2>&1
	cd add_to_obb
	if test -z "$*"; then
		bmsay "我不知道你要安装哪些文件.\n" 31m
		pause
		return 1
	fi
	ext=" "
	if test ! -f "/sdcard/Android/obb/bm.kleientertainment.doNotStarveShipwrecked/main.50.bm.kleientertainment.doNotStarveShipwrecked.obb"; then
		mkdir -p temp
		mkdir -p "/sdcard/Android/obb/bm.kleientertainment.doNotStarveShipwrecked"
		7z a -tzip "/sdcard/Android/obb/bm.kleientertainment.doNotStarveShipwrecked/main.50.bm.kleientertainment.doNotStarveShipwrecked.obb" "temp"
		7z d -tzip "/sdcard/Android/obb/bm.kleientertainment.doNotStarveShipwrecked/main.50.bm.kleientertainment.doNotStarveShipwrecked.obb" "temp"
		ext=" 200601 999999 "
	fi
	rm -rf temp.zip temp
	mkdir -p temp
	
	ids=$(echo "$ext""$*" )
	for id in $ids ; do
	  id=$(echo "$id" | tr -cd "[0-9]")
		if test -n "$id"; then
			fname=$(printf "BM%04d" "$id")
			bmsay "安装""$fname""...\n" 33m
			get_file_github "$id" temp.zip
			7z x -tzip "temp.zip" -otemp -aoa
			dir=$(find "temp" -name "*ADD_TO_OBB")
			cp -r "$dir"/* "./"
			rm -rf temp.zip temp >/dev/null 2>&1
			7z a -tzip "/sdcard/Android/obb/bm.kleientertainment.doNotStarveShipwrecked/main.50.bm.kleientertainment.doNotStarveShipwrecked.obb" "./*"
			if test "$?" -eq "0"; then
				bmsay "安装""$fname""成功.\n" 32m
			else
				bmsay "安装""$fname""失败.\n" 31m
			fi
		fi
	done
	pause
	return 1
	rm -rf add_to_obb
}

#修改安装包
function add_to_apk() {

	cd /sdcard/bmsh >/dev/null 2>&1
	rm -rf add_to_apk >/dev/null 2>&1
	mkdir -p add_to_apk >/dev/null 2>&1

	#附带外部数据包：检测是否有“安装”文件
	if test -n "$*"; then
		if test ! -f "/sdcard/Android/obb/bm.kleientertainment.doNotStarveShipwrecked/main.50.bm.kleientertainment.doNotStarveShipwrecked.obb"; then
			bmsay "你好像还没有“安装”文件.\n" 31m
			pause
			main
		fi
	fi

	bmsh_sw_key_exist

	bmsh_sw_jks_exist

	bmsh_sw_apk_exist

	bmsh_sw_obb_exist

	bmsh_sw_zip_exist

	rm -rf assets patch

	bmsay "解压BMSH200601.OBB...\n" 33m
	7z x -tzip "BMSH200601.OBB" -oassets -aoa
	if test "$?" -eq "0"; then
		bmsay "解压BMSH200601.OBB成功.\n" 32m
	else
		bmsay "解压BMSH200601.OBB失败.\n" 31m
		pause
		main
	fi

	app_rename="/sdcard/船难_小黑_自用.APK"
	#附带外部数据包：解压文件
	if test -n "$*"; then
		#add_to_obb "$*"
		if test -f "/sdcard/Android/obb/bm.kleientertainment.doNotStarveShipwrecked/main.50.bm.kleientertainment.doNotStarveShipwrecked.obb"; then
			7z x -tzip "/sdcard/Android/obb/bm.kleientertainment.doNotStarveShipwrecked/main.50.bm.kleientertainment.doNotStarveShipwrecked.obb" -oassets -aoa
			app_rename="/sdcard/船难_小黑_分享.APK"
		fi
	fi

	bmsay "解压BMSH200601.OPH...\n" 33m
	7z x -tzip "BMSH200601.OPH" -opatch -aoa
	if test "$?" -eq "0"; then
		bmsay "解压BMSH200601.OPH成功.\n" 32m
	else
		bmsay "解压BMSH200601.OPH失败.\n" 31m
		pause
		main
	fi

	bmsay "生成BMSH200601.APP...\n" 33m
	cp "BMSH200601.APP" "BMSH200601_SIGN.APK"
	7z a -tzip "BMSH200601_SIGN.APK" "assets"
	7z a -tzip "BMSH200601_SIGN.APK" "./patch/bmsh-patch-GIT200601/GIT200601/ADD_TO_APK/*"
	if test "$?" -eq "0"; then
		bmsay "生成BMSH200601.APP成功.\n" 32m
	else
		bmsay "生成BMSH200601.APP失败.\n" 31m
		pause
		main
	fi

	bmsay "生成APP签名验证文件...\n" 33m
	apksigner -p bmsh_sw "BMSH200601.JKS" "BMSH200601_SIGN.APK" "TEMP.APK"
	if test "$?" -eq "0"; then
		bmsay "生成APP签名验证文件成功.\n" 32m
	else
		bmsay "生成APP签名验证文件失败.\n" 31m
		pause
		main
	fi
	bmsay "签名BMSH200601.APP...\n" 33m
	7z x -tzip "TEMP.APK" META-INF -aoa
	7z a -tzip "BMSH200601_SIGN.APK" "META-INF"
	if test "$?" -eq "0"; then
		bmsay "签名BMSH200601.APP成功.\n" 32m
	else
		bmsay "签名BMSH200601.APP失败.\n" 31m
		pause
		main
	fi

	
	bmsay "移动BMSH200601.APP...\n" 32m
	rm -rf assets patch META-INF TEMP.APK /sdcard/船难_小黑*.APK
	mv "BMSH200601_SIGN.APK" "$app_rename"
	if test "$?" -eq "0"; then
		bmsay "移动BMSH200601.APP成功.\n" 32m
		bmsay "请手动安装 /sdcard/船难(BM).APK .\n" 34m
	else
		bmsay "移动BMSH200601.APP失败.\n" 31m
		pause
		main
	fi
	rm -rf add_to_obb
}

init
main 0
